<!DOCTYPE html>
<html lang="zh">
<head>
  <title>转世三国-模拟三国人生</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../css/w3.css">
  <link rel="stylesheet" href="../css/all.css">
  <link rel="stylesheet" href="../css/my-style.css">
  <link rel="icon" href="../img/logo.png"/>
  <link href="../css/leaflet.css" rel="stylesheet" />

  <!--加载leaflet地图js-->
  <script src="../js/leaflet.js"></script>
  <script src="../js/leaflet.ChineseTmsProviders.js"></script>
</head>

<body class="w3-animate-opacity">
<!--  载入的navSideBar-->
<div style="position: relative" id="nav-placeholder"></div>

<!--正文内容-->
<div id="customContent" style="margin-left:0;" class="w3-row">

<!-- mapMenu-->
  <ul class="w3-col w3-light-gray w3-card-4" style="width:250px;margin-top:80px;list-style-type:none;border-radius: 50px 0 0 50px;" id="mapMenu">
    <li class="w3-xxlarge">魏国</li>
    <li class="w3-xlarge">河北</li>
    <li class="w3-large">幽州</li>
    <li onclick="getMap(1);"><a href="#">襄平  幽州─辽东郡</a></li>
    <li onclick="getMap(2);"><a href="#">北平  幽州—右北平郡</a></li>
    <li onclick="getMap(3);"><a href="#">蓟  幽州─燕国蓟县</a></li>
    <li class="w3-large">冀州</li>
    <li onclick="getMap(4);"><a href="#">南皮  冀州─渤海郡</a></li>
    <li onclick="getMap(5);"><a href="#">中山  冀州─中山郡</a></li>
    <li onclick="getMap(6);"><a href="#">钜鹿  冀州─巨鹿郡</a></li>
    <li onclick="getMap(7);"><a href="#">甘陵  冀州─清河郡</a></li>
    <li onclick="getMap(8);"><a href="#">邺  冀州─魏郡</a></li>
    <li class="w3-large">并州</li>
    <li onclick="getMap(9);"><a href="#">晋阳  并州─太原郡</a></li>
    <li onclick="getMap(10);"><a href="#">上党  并州─上党郡</a></li>
    <li class="w3-large">青州</li>
    <li onclick="getMap(11);"><a href="#">平原  青州─平原郡</a></li>
    <li onclick="getMap(12);"><a href="#">北海  青州─北海国</a></li>

    <li class="w3-xlarge">中原</li>
    <li class="w3-large">徐州</li>
    <li onclick="getMap(13);"><a href="#">琅琊  徐州─琅琊国</a></li>
    <li onclick="getMap(14);"><a href="#">下邳  徐州─州治</a></li>
    <li onclick="getMap(15);"><a href="#">广陵  徐州─广陵郡</a></li>
    <li class="w3-large">兖州</li>
    <li onclick="getMap(16);"><a href="#">济北 兖州─济阳郡</a></li>
    <li onclick="getMap(17);"><a href="#">濮阳  兖州─东郡</a></li>
    <li onclick="getMap(18);"><a href="#">陈留  兖州─陈留国</a></li>
    <li class="w3-large">豫州</li>
    <li onclick="getMap(19);"><a href="#">小沛  豫州─沛国</a></li>
    <li onclick="getMap(20);"><a href="#">谯  豫州─谯郡</a></li>
    <li onclick="getMap(21);"><a href="#">许昌  豫州─颖川郡</a></li>
    <li onclick="getMap(22);"><a href="#">汝南  豫州─汝南郡</a></li>
    <li onclick="getMap(23);"><a href="#">宛  豫州─南阳郡</a></li>
    <li class="w3-large">司隶</li>
    <li onclick="getMap(24);"><a href="#">河内  司隶─河内郡</a></li>
    <li onclick="getMap(25);"><a href="#">洛阳  司隶─河南尹</a></li>
    <li onclick="getMap(26);"><a href="#">弘农  司隶─弘农郡</a></li>


    <li class="w3-xxlarge">蜀国</li>
    <li class="w3-xlarge">西北</li>
    <li class="w3-large">雍州</li>
    <li onclick="getMap(27);"><a href="#">长安  雍州─京兆尹</a></li>
    <li onclick="getMap(28);"><a href="#">安定  雍州─安定郡</a></li>
    <li onclick="getMap(29);"><a href="#">天水  雍州─天水郡</a></li>
    <li class="w3-large">凉州</li>
    <li onclick="getMap(30);"><a href="#">武威  凉州─武威郡</a></li>
    <li onclick="getMap(31);"><a href="#">金城  凉州─金城郡</a></li>

    <li class="w3-xlarge">巴蜀</li>
    <li class="w3-large">益州</li>
    <li onclick="getMap(32);"><a href="#">武都  益州─武都郡</a></li>
    <li onclick="getMap(33);"><a href="#">汉中  益州─汉中郡</a></li>
    <li onclick="getMap(34);"><a href="#">永安  益州─巴东郡</a></li>
    <li onclick="getMap(35);"><a href="#">梓潼  益州─梓潼郡</a></li>
    <li onclick="getMap(36);"><a href="#">成都  益州─蜀郡</a></li>
    <li onclick="getMap(37);"><a href="#">江州  益州─巴郡</a></li>
    <li onclick="getMap(38);"><a href="#">牂牁  益州─牂牁郡</a></li>
    <li onclick="getMap(39);"><a href="#">越巂  益州─越巂郡</a></li>
    <li onclick="getMap(40);"><a href="#">建宁  益州─建宁郡</a></li>
    <li onclick="getMap(41);"><a href="#">永昌  益州─永昌郡</a></li>
    <li onclick="getMap(42);"><a href="#">上庸  益州─上庸郡</a></li>


    <li class="w3-xxlarge">吴国</li>
    <li class="w3-xlarge">荆楚</li>
    <li class="w3-large">荆州</li>
    <li onclick="getMap(43);"><a href="#">新野  荆州─南阳郡</a></li>
    <li onclick="getMap(44);"><a href="#">襄阳  荆州─襄阳郡</a></li>
    <li onclick="getMap(45);"><a href="#">江夏  荆州─江夏郡</a></li>
    <li onclick="getMap(46);"><a href="#">江陵  荆州─南郡</a></li>
    <li onclick="getMap(47);"><a href="#">长沙  荆州─长沙郡</a></li>
    <li onclick="getMap(48);"><a href="#">武陵  荆州─武陵郡</a></li>
    <li onclick="getMap(49);"><a href="#">桂阳  荆州─桂阳郡</a></li>
    <li onclick="getMap(50);"><a href="#">零陵  荆州─零陵郡</a></li>

    <li class="w3-xlarge">吴越</li>
    <li class="w3-large">扬州</li>
    <li onclick="getMap(51);"><a href="#">寿春  扬州─州治</a></li>
    <li onclick="getMap(52);"><a href="#">庐江  扬州─庐江郡</a></li>
    <li onclick="getMap(53);"><a href="#">建业  扬州─丹阳郡</a></li>
    <li onclick="getMap(54);"><a href="#">吴  扬州─吴郡</a></li>
    <li onclick="getMap(55);"><a href="#">会稽  扬州─会稽郡</a></li>
    <li onclick="getMap(56);"><a href="#">豫章  扬州─豫章郡</a></li>
    <li onclick="getMap(57);"><a href="#">建安  扬州─建安郡</a></li>
    <li class="w3-large">交州</li>
    <li onclick="getMap(58);"><a href="#">南海  交州─南海郡</a></li>
    <li onclick="getMap(59);"><a href="#">合浦  交州─合浦郡</a></li>
    <li onclick="getMap(60);"><a href="#">交趾  交州─龙编</a></li>

  </ul>

  <!--地图contianer-->
  <div id="mapContainer" class="w3-rest w3-card-4" style="margin-top:80px">
    <div id="mapLayer"></div>
  </div>
</div>

<!--Script加载顺序!!!!!-->
<!--加载jquery-->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>console.log("Jquery加载完毕")</script>
<script src="../js/handlebars.min.js"></script>
<script>console.log("handlebars加载完毕")</script>

<!--初始化用户并加载user.js-->
<script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.14.0/dist/av-min.js"></script>
<script src="../js/initLeanCloud.js"></script>
<script src="../js/user.js"></script> <!--登录注册,登出,isCurrentUser-->
<script>console.log("User初始化完毕;")</script>

<!--加载counter.js-->
<script src="../js/counter.js"></script> <!--活动倒计时,东汉年历,当前时间-->

<!--使用jquery 加载navSideBar和userMenu到相关的placeholder中-->
<!--这个script执行完只是call了jquery.load,可能jquery.load要load的内容还没有加载完,此时后面加载的js,如果依赖于load的内容则可能会报错-->
<!--解决办法  $("#nav-placeholder").load("navSideBar.html", function(){ $.getScript("../js/navSideBar.js");}-->
<script>
    $("#nav-placeholder").load("navSideBar.html", function(){
        console.log("navSideBar加载完毕");

        $.getScript("../js/navSideBar.js", function(){
            console.log("navSideBar.js读取完毕,开始执行setProfileData&displayRightOnLarge");
            setProfileData();
            displayRightOnLarge();
            $.getScript("../js/translate.js", function(){
                console.log("translate.js读取完毕,开始执行detectLang");
                detectLang();
            });
        });
    });
</script>

<script>
    /*** 高德地图*/
    var Gaode = L.tileLayer.chinaProvider('GaoDe.Normal.Map', {maxZoom: 18,minZoom: 5});
    var Gaodimgem = L.tileLayer.chinaProvider('GaoDe.Satellite.Map', {maxZoom: 18,minZoom: 5});
    var Gaodimga = L.tileLayer.chinaProvider('GaoDe.Satellite.Annotion', {maxZoom: 18,minZoom: 5});
    var Gaodimage = L.layerGroup([Gaodimgem, Gaodimga]);

    var map = L.map("mapLayer", {
        center: [35.74874, 116.05408],
        zoom: 5,
        layers: [Gaode],
        zoomControl: false
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="https://zssanguo.com">转世三国</a>'}).addTo(map);

    // 和平状态蜀国城池图标
    var shuCityIcon = L.icon({
        iconUrl: 'https://zssanguo.com/img/shuCityIcon.png',
        iconSize:     [48,48],    // size of the icon
        // iconAnchor:   [30,30], // point of the icon which will correspond to marker's location
        popupAnchor:  [-5, -40] // point from which the popup should open relative to the iconAnchor
    });

    // 和平状态魏国城池图标
    var weiCityIcon = L.icon({
        iconUrl: 'https://zssanguo.com/img/weiCityIcon.png',
        iconSize:     [48,48],    // size of the icon
        // iconAnchor:   [30,30], // point of the icon which will correspond to marker's location
        popupAnchor:  [-5, -40] // point from which the popup should open relative to the iconAnchor
    });

    // 和平状态吴国城池图标
    var wuCityIcon = L.icon({
        iconUrl: 'https://zssanguo.com/img/wuCityIcon.png',
        iconSize:     [48,48],    // size of the icon
        popupAnchor:  [-5, -40] // point from which the popup should open relative to the iconAnchor
    });

    var warCityIcon = L.icon({
        iconUrl: 'https://zssanguo.com/img/warCityIcon.png',
        iconSize:     [48,48],    // size of the icon
        popupAnchor:  [-5, -40] // point from which the popup should open relative to the iconAnchor
    });

    // 编号,城市名称,坐标,图片地址,描述内容,点击链接
    var list = [
        // 魏国城池 26座
        [1,'襄平',[41.26955, 123.17596],'','<p>	所属州郡：幽州─辽东郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [2,'北平',[41.24271, 119.41589],'','<p>所属州郡：幽州─右北平郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [3,'蓟',[40.04864, 117.39716],'','<p>所属州郡：幽州─燕国蓟县</p><span>所属国家：</span>','https://zssanguo.com'],
        [4,'南皮',[38.05674, 116.70502],'','<p>	所属州郡：冀州─渤海郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [5,'中山',[38.51594, 115.00488],'','<p>所属州郡：冀州─中山郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [6,'钜鹿',[37.63381, 114.93073],'','<p>所属州郡：冀州─巨鹿郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [7,'甘陵',[36.84666, 115.71075],'','<p>所属州郡：冀州─清河郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [8,'邺',[36.59348, 114.49402],'','<p>所属州郡：冀州─魏郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [9,'晋阳',[37.90737, 112.56317],'','<p>	所属州郡：并州─太原郡─州治</p><span>所属国家：</span>','https://zssanguo.com'],
        [10,'上党',[36.22544, 113.1015],'','<p>所属州郡：并州─上党郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [11,'平原',[37.18439, 116.44135],'','<p>	所属州郡：冀州─平原郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [12,'北海',[36.72788, 119.20029],'','<p>	所属州郡：青州─北海国</p><span>所属国家：</span>','https://zssanguo.com'],
        [13,'琅琊',[35.06148, 118.32275],'','<p>所属州郡：徐州─琅琊国</p><span>所属国家：</span>','https://zssanguo.com'],
        [14,'下邳',[33.94336, 118.02612],'','<p>	所属州郡：徐州─州治</p><span>所属国家：</span>','https://zssanguo.com'],
        [15,'广陵',[33.53224, 119.03687],'','<p>	所属州郡：徐州─广陵郡</p><span>	所属国家：</span>','https://zssanguo.com'],
        [16,'济北',[35.18279, 115.46631],'','<p>所属州郡：兖州─济北国</p><span>所属国家：</span>','https://zssanguo.com'],
        [17,'濮阳',[35.69299, 115.02686],'','<p>	所属州郡：兖州─东郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [18,'陈留',[34.67388, 114.53522],'','<p>	所属州郡：兖州─陈留国</p><span>所属国家：</span>','https://zssanguo.com'],
        [19,'小沛',[34.7371, 116.95633],'','<p>所属州郡：豫州─沛国</p><span>所属国家：</span>','https://zssanguo.com'],
        [20,'谯',[33.85217, 115.77942],'','<p>所属州郡：豫州─谯郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [21,'许昌',[34.03104, 113.82797],'','<p>所属州郡：豫州─颖川郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [22,'汝南',[33.27658, 114.26605],'','<p>	所属州郡：豫州─汝南郡─州治</p><span>所属国家：</span>','https://zssanguo.com'],
        [23,'宛',[32.98102, 112.54395],'','<p>所属州郡：豫州─南阳郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [24,'河内',[35.10418, 113.41873],'','<p>所属州郡：司隶─河内郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [25,'洛阳',[34.6366, 112.46292],'','<p>所属州郡：司隶─河南尹</p><span>所属国家：</span>','https://zssanguo.com'],
        [26,'弘农',[34.52466, 110.89874],'','<p>	所属州郡：司隶─弘农郡</p><span>所属国家：</span>','https://zssanguo.com'],

        // 蜀国城池  16座
        [27,'长安',[34.34996, 108.94009],'','<p>所属州郡：雍州─京兆尹─州治</p><span>所属国家：</span>','https://zssanguo.com'],
        [28,'安定',[35.33641, 107.36389],'','<p>所属州郡：雍州─安定郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [29,'天水',[34.8634, 105.66101],'','<p>所属州郡：雍州─天水郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [30,'武威',[37.93662, 102.62466],'','<p>所属州郡：凉州─武威郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [31,'金城',[36.0491, 103.83179],'','<p>所属州郡：凉州─金城郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [32,'武都',[33.74261, 105.76263],'','<p>所属州郡：益州─武都郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [33,'汉中',[33.07773, 107.02881],'','<p>	所属州郡：益州─汉中郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [34,'永安',[31.0191, 109.47464],'','<p>所属州郡：益州─巴东郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [35,'梓潼',[31.64403, 105.18311],'','<p>	所属州郡：益州─梓潼郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [36,'成都',[30.57645, 104.07349],'','<p>所属州郡：益州─蜀郡─州治</p><span>所属国家：</span>','https://zssanguo.com'],
        [37,'江州',[29.54957, 106.55365],'','<p>所属州郡：益州─巴郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [38,'牂牁',[26.26633, 107.52869],'','<p>所属州郡：益州─徉柯郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [39,'越巂',[27.87975, 102.26761],'','<p>所属州郡：益州─越隽郡</p><span>所属国家： </span>','https://zssanguo.com'],
        [40,'建宁',[25.48543, 103.79883],'','<p>所属州郡：益州─建宁郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [41,'永昌',[25.10923, 99.16122],'','<p>所属州郡：益州─永昌郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [42,'上庸',[32.23836, 110.2533],'','<p>所属州郡：益州─上庸郡</p><span>所属国家：</span>','https://zssanguo.com'],
        //吴国城池 18座

        [43,'新野',[32.53176, 112.36679],'','<p>	所属州郡：荆州─南阳郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [44,'襄阳',[32.05464, 112.13882],'','<p>	所属州郡：荆州─襄阳郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [45,'江夏',[31.02411, 113.75381],'','<p>	所属州郡：荆州─江夏郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [46,'江陵',[30.36103, 112.18964],'','<p>	所属州郡：荆州─南郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [47,'长沙',[29.4683, 113.45581],'','<p>所属州郡：荆州─长沙郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [48,'武陵',[29.02976, 111.6925],'','<p>所属州郡：荆州─武陵郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [49,'桂阳',[25.743, 112.73895],'','<p>	所属州郡：荆州─桂阳郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [50,'零陵',[26.22445, 111.63208],'','<p>所属州郡：荆州─零陵郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [51,'寿春',[32.58038, 116.79291],'','<p>	所属州郡：扬州─州治</p><span>所属国家：</span>','https://zssanguo.com'],
        [52,'庐江',[30.73593, 116.83685],'','<p>	所属州郡：扬州─庐江郡─州治</p><span>所属国家：</span>','https://zssanguo.com'],
        [53,'建业',[31.99876, 118.79517],'','<p>所属州郡：扬州─丹阳郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [54,'吴',[31.29967, 120.62164],'','<p>所属州郡：扬州─吴郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [55,'会稽',[29.99895, 120.58182],'','<p>所属州郡：扬州─会稽郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [56,'豫章',[28.70022, 115.85083],'','<p>	所属州郡：扬州─豫章郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [57,'建安',[27.02457, 118.30593],'','<p>	所属州郡：扬州─建安郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [58,'南海',[22.93848, 113.38852],'','<p>	所属州郡：交州─南海郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [59,'合浦',[21.68295, 109.23157],'','<p>所属州郡：交州─合浦郡</p><span>所属国家：</span>','https://zssanguo.com'],
        [60,'交趾',[21.01273, 105.82855],'','<p>所属州郡：交州─龙编</p><span>所属国家：</span>','https://zssanguo.com'],
    ];

    // 地图上显示城池
    const battlehtml = "../html/city.html?id=";
    // 因为mapID是从1开始的,list index是从0开始的,所以记得要减一
    var query = new AV.Query('city');
    query.include(['owner']);
    query.find().then(function (cities) {
        cities.forEach(function(city) {
            if ( city.get("isAtWar") === false){
                if (city.get('owner').get('name') === "weiguo"){
                    $j = city.get('cityId');                                                                                                                       //编号+城市名+所属州郡+现在地址+战场链接
                    L.marker([list[$j-1][2][0],list[$j-1][2][1]],{icon: weiCityIcon}).addTo(map).bindPopup("<div class='popupInfo'><h3><font color='#00a6ac'>" +list[$j-1][0] + ". " + list[$j-1][1] + "</font></h3>"+ list[$j-1][4]  + city.get('owner').get('cname') + "<br><br>" + "<a  href='"+ battlehtml + [$j] + "' target=_blank>" +"进入城市"+"</a></div>");
                }else if (city.get('owner').get('name') === "shuguo"){
                    $j = city.get('cityId');
                    L.marker([list[$j-1][2][0],list[$j-1][2][1]],{icon: shuCityIcon}).addTo(map).bindPopup("<div class='popupInfo'><h3><font color='#00a6ac'>" +list[$j-1][0] + ". " + list[$j-1][1] + "</font></h3>"+ list[$j-1][4]  + city.get('owner').get('cname') + "<br><br>" + "<a  href='"+ battlehtml + [$j] + "' target=_blank>" +"进入城市"+"</a></div>");
                }else if (city.get('owner').get('name') === "wuguo"){
                    $j = city.get('cityId');
                    L.marker([list[$j-1][2][0],list[$j-1][2][1]],{icon: wuCityIcon}).addTo(map).bindPopup("<div class='popupInfo'><h3><font color='#00a6ac'>" +list[$j-1][0] + ". " + list[$j-1][1] + "</font></h3>"+ list[$j-1][4]  + city.get('owner').get('cname') + "<br><br>" + "<a  href='"+ battlehtml + [$j] + "' target=_blank>" +"进入城市"+"</a></div>");
                }else{
                    $j = city.get('cityId');
                    L.marker([list[$j-1][2][0],list[$j-1][2][1]],{icon: huangCityIcon}).addTo(map).bindPopup("<div class='popupInfo'><h3><font color='#00a6ac'>" +list[$j-1][0] + ". " + list[$j-1][1] + "</font></h3>"+ list[$j-1][4]  + city.get('owner').get('cname') + "<br><br>" + "<a  href='"+ battlehtml + [$j] + "' target=_blank>" +"进入城市"+"</a></div>");
                }
            }else{
                $j = city.get('cityId');
                L.marker([list[$j-1][2][0],list[$j-1][2][1]],{icon: warCityIcon}).addTo(map).bindPopup("<div class='popupInfo'><h3><font color='#00a6ac'>" +list[$j-1][0] + ". " + list[$j-1][1] + "</font></h3>"+ list[$j-1][4]  + "交战中!" + "<br><br>" + "<a  href='"+ battlehtml + [$j] + "' target=_blank>" +"进入城市"+"</a></div>");
            }

        });
    });

    //点击mapMenu显示popUp
    function getMap(cityID) {
        console.log("cityId是: "+ cityID);
        var query = new AV.Query('city');
        query.include(['owner']);
        query.equalTo('cityId', cityID);
        query.find().then(function(cities){
            var city = cities[0];
            console.log(city.get("name"));
            $j=cityID-1;

            if ( city.get("isAtWar") === false){
                if (city.get('owner').get('name') === "weiguo"){
                    L.marker([list[$j][2][0],list[$j][2][1]],{icon: weiCityIcon}).addTo(map).bindPopup("<div class='popupInfo'><h3><font color='#00a6ac'>" +list[$j][0] + ". " + list[$j][1] + "</font></h3>"+ list[$j][4]  + city.get('owner').get('cname') + "<br><br>" + "<a  href='"+ battlehtml + [$j+1] + "' target=_blank>" +"进入城市"+"</a></div>").openPopup();
                }else if (city.get('owner').get('name') === "shuguo"){
                    L.marker([list[$j][2][0],list[$j][2][1]],{icon: shuCityIcon}).addTo(map).bindPopup("<div class='popupInfo'><h3><font color='#00a6ac'>" +list[$j][0] + ". " + list[$j][1] + "</font></h3>"+ list[$j][4]  + city.get('owner').get('cname') + "<br><br>" + "<a  href='"+ battlehtml + [$j+1] + "' target=_blank>" +"进入城市"+"</a></div>").openPopup();
                }else if (city.get('owner').get('name') === "wuguo"){
                    L.marker([list[$j][2][0],list[$j][2][1]],{icon: wuCityIcon}).addTo(map).bindPopup("<div class='popupInfo'><h3><font color='#00a6ac'>" +list[$j][0] + ". " + list[$j][1] + "</font></h3>"+ list[$j][4]  + city.get('owner').get('cname') + "<br><br>" + "<a  href='"+ battlehtml + [$j+1] + "' target=_blank>" +"进入城市"+"</a></div>").openPopup();
                }else{
                    L.marker([list[$j][2][0],list[$j][2][1]],{icon: huangCityIcon}).addTo(map).bindPopup("<div class='popupInfo'><h3><font color='#00a6ac'>" +list[$j][0] + ". " + list[$j][1] + "</font></h3>"+ list[$j][4]  + city.get('owner').get('cname') + "<br><br>" + "<a  href='"+ battlehtml + [$j+1] + "' target=_blank>" +"进入城市"+"</a></div>").openPopup();
                }
            }else{
                L.marker([list[$j][2][0],list[$j][2][1]],{icon: warCityIcon}).addTo(map).bindPopup("<div class='popupInfo'><h3><font color='#00a6ac'>" +list[$j][0] + ". " + list[$j][1] + "</font></h3>"+ list[$j][4]  + "交战中!" + "<br><br>" + "<a  href='"+ battlehtml + [$j+1] + "' target=_blank>" +"进入城市"+"</a></div>").openPopup();
            }
        });
    }

    /**/
    var popup = new L.popup();
    function onMapClick(e) {
        popup.setLatLng(e.latlng).setContent("您当前的坐标为 " + e.latlng.toString()).openOn(map);
    }
    map.on('click', onMapClick);

    if(top != self){
        window.top.location.replace(self.location);
    }
</script>

</body>
</html>