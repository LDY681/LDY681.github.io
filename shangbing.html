/*
怎么获取数据
mapData = GameGlaivesManager.GetInstance().mapCitys
var countryScoreRankList = GameGlaivesManager.GetInstance().rankListInfo.countryScoreRankList
var countryRanks = GameGlaivesManager.GetInstance().rankListInfo.countryRanks
var res = {
lastTime: now,
mapData: mapData,
rankData: {
countryScoreRankList: countryScoreRankList,
countryRanks: countryRanks
}
}
*/

<html>
	<head>
	<meta charset="utf-8">
<meta name="x5-page-mode" content="no-title" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui,shrink-to-fit=no"/>
<meta name="format-detection" content="telephone=no"/>
<title>上兵伐谋地图助手</title>
	</head>
	<body>
		<ol id="tips">
			<li>板块大小对应州/郡/关隘，无旗号默认显示为“N”</li>
			<li>地图尺寸过大，拖动屏幕可查看完整地图</li>
			<li>带“驻”图标表示该城池暂未驻满。红驻代表开放驻守，黑驻代表未开放</li>
			<li>如地图无法显示，请更换为chrome/firefox/edge浏览器进行查看</li>
			<li>鼠标悬浮可查详情，闪烁代表防御薄弱。</li>
			<li>原作者:gumpwen@gmail.com</li>
			<li><a style="cursor: pointer;color: #001fff;text-decoration: underline;" onclick="changeShow(this)" data-type="1">查看统计信息</a></li>
			<li id="upInfo"></li>
			<a href="https://www.zssanguo.com"><button>数据过时? 如何更新数据+帮助他人看到最新数据</button></a>
		</ol>	
		<div id="map"></div>
		<div id="count" style="display:none">
			<p class="tit">势力排名：</p>
			<table id="contry"></table>
			<p class="tit">公会排名：<label style="font-size:12px">（默认显示top10，你也可以<a style="cursor: pointer;color: #001fff;text-decoration: underline; font-size:12px" onclick="setGuildRank(400)">点击查看top400数据</a>）</label></p>
			<table id="guild"></table>
			<p class="tit">城池占据情况：<label style="font-size:12px">（上下左右拖动屏幕查看完整数据）</label></p>
			<ul>
				<li class="qunInfo">
					<p></p>
					<table></table>
				</li>
				<li class="weiInfo">
					<p></p>
					<table></table>
				</li>
				<li class="wuInfo">
					<p></p>
					<table></table>
				</li>
				<li class="shuInfo">
					<p></p>
					<table></table>
				</li>
			</ul>		
			
		</div>
		<div style="display:none"><script type="text/javascript" src="https://s5.cnzz.com/z_stat.php?id=1277662082&web_id=1277662082"></script></div>
	</body>
</html>
<script src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script>
 var now=Date.parse(new Date())/1000;
 var searchTime=location.search.length==0?false:isNaN(parseInt(location.search.substr(1,location.search.length)))?false:parseInt(location.search.substr(1,location.search.length));
 
 if(!searchTime || (now-searchTime>300)){
	refreshPage();
 }
function changeShow(e){
	let html="查看地图信息"
	$("#count").show();
	$("#map").hide();
	if($(e).attr("data-type")==2){
		$(e).attr("data-type",1)
		html="查看统计信息";
		$("#count").hide();
		$("#map").show();
	}else{
		$(e).attr("data-type",2)
	}
	$(e).html(html)
}

var dataInfo=null;
var sumScore=0;
$.get("http://dms.zssanguo.com/sb",function(res){
}

var res =
dataInfo=JSON.parse(res);
$("#upInfo").html("数据更新日期："+formatDate(dataInfo.lastTime))
setMap()
setCount();

function setCountryRank(){
	let html="<thead><tr><td>势力</td><td>排名</td><td>积分</td><td>占比</td></tr></thead>";
	$.each(dataInfo.rankData.countryScoreRankList,function(i,val){
		let fac=getFontAndColor(val.country);
		html+='<tr style="color:'+fac.color+'">';
		html+="<td>"+fac.font+"</td>"
		html+="<td>"+val.rank+"</td>"
		html+="<td>"+val.totalScore+"</td>"
		html+="<td></td>"
		html+="</tr>"
		sumScore+=val.totalScore;
	})
	$("#contry").html(html).find("td").each(function(i){
		if((i+1)%4==0&&i!=3){
			$(this).html(toPercent(parseInt($(this).prev().html())/sumScore));
		}
	});
	
}

function setGuildRank(num){
	var guildData=sortGuildRank(dataInfo.rankData.countryRanks);
	let html="<thead><tr><td>总排名</td><td>势力排名</td><td>势力</td><td>公会</td><td>积分</td><td>占比</td><td>瓜分</td></tr></thead>";
	for(let i=0;i<num;i++){
		let guild=guildData[i];
		let fac=getFontAndColor(guild.country);
		
		html+='<tr style="color:'+fac.color+'">';
		html+="<td>"+(parseInt(i)+1)+"</td>"
		html+="<td>"+guild.rank+"</td>"
		html+="<td>"+fac.font+"</td>"
		html+="<td>"+guild.guildName+"</td>"
		html+="<td>"+guild.totalScore+"</td>"
		html+="<td>"+toPercent(guild.gdp)+"</td>"
		html+="<td>公会经验："+Math.ceil((100000000*guild.gdp))+"&nbsp;&nbsp;公会财富："+Math.ceil((12000000*guild.gdp))+"&nbsp;&nbsp;贡献度："+Math.ceil((50000000*guild.gdp))+"&nbsp;&nbsp;绿蛋"+Math.ceil((900000*guild.gdp))+"&nbsp;&nbsp;上兵伐谋宝箱"+Math.ceil((90000*guild.gdp))+"</td>"
		html+="</tr>";
	}
	$("#guild").html(html)
}
function sortGuildRank(guilds){
	var allGuilds=[];
	var newCount=[];
	$.each(guilds,function(i,val){
		for(let i in val.rankItems){
			let guild=val.rankItems[i];
			allGuilds.push({rank:(parseInt(i)+1),country:val.country,totalScore:guild.totalScore,guildName:guild.guildName,gdp:guild.totalScore/sumScore})
		}
	})
	var keysSorted = Object.keys(allGuilds).sort(function(a,b){
		return allGuilds[b].totalScore-allGuilds[a].totalScore
	})
	for(let i=0;i<keysSorted.length;i++){
		newCount[i]=allGuilds[keysSorted[i]];
	}
	return newCount;
}

function toPercent(point){
    var str=Number(point*100).toFixed(2);
    str+="%";
    return str;
}
function getFontAndColor(countryId){
	let country="";
	let color="";
	switch(countryId){
			case 1:
				country="魏";
				color="#55a6fd";
				break;
			case 2:
				country="蜀";
				color="#960b0e";
				break;
			case 3:
				country="吴";
				color="#00af50";
				break;
			case 4:
				country="群";
				color="#ff8216";
				break;
	}
	return {font:country,color:color}
}

function setCountInfo(){
	var wei={guild:[]};
	var shu={guild:[]};
	var wu={guild:[]};
	var qun={guild:[]};
	for(let data of dataInfo.mapData){
		switch(data.Country){
			case 1:
				addCountData(data,wei);
			break;
			case 2:
				addCountData(data,shu);
			break;
			case 3:
				addCountData(data,wu);
			break;
			case 4:
				addCountData(data,qun);
			break;
		}
	}
	return {wei:orderCountObj(wei),shu:orderCountObj(shu),wu:orderCountObj(wu),qun:orderCountObj(qun)}
}

function addCountData(data,obj){
	if(data.CityType==1){return;}
	if(obj.guild[data.guildName]==undefined){
		obj.guild[data.guildName]={};
		obj.guild[data.guildName].city={};
		obj.guild[data.guildName].orderCount=0;
	}
	switch(data.CityType){
		case 2:
			obj.z=obj.z==undefined?1:obj.z+1;
			obj.guild[data.guildName].city.z==undefined?obj.guild[data.guildName].city.z=[data.NodeName]:obj.guild[data.guildName].city.z.push(data.NodeName);
			obj.guild[data.guildName].orderCount+=(20*50);
		break;
		case 3:
			obj.j=obj.j==undefined?1:obj.j+1
			obj.guild[data.guildName].city.j==undefined?obj.guild[data.guildName].city.j=[data.NodeName]:obj.guild[data.guildName].city.j.push(data.NodeName);
			obj.guild[data.guildName].orderCount+=(10*40)
		break;
		case 4:
			obj.g=obj.g==undefined?1:obj.g+1
			obj.guild[data.guildName].city.g==undefined?obj.guild[data.guildName].city.g=[data.NodeName]:obj.guild[data.guildName].city.g.push(data.NodeName);
			obj.guild[data.guildName].orderCount+=(5*30)
		break;
	}
	
}



function setCount(){
	var countInfo=setCountInfo();
	for(let key in countInfo){
		let outline="州："+countInfo[key].z+"&nbsp;&nbsp;&nbsp;&nbsp;郡："+countInfo[key].j+"&nbsp;&nbsp;&nbsp;&nbsp;关隘："+countInfo[key].g;
		let table="<thead><tr><td>公会</td><td>州</td><td>郡</td><td>关隘</td><td>分值/H</td></tr></thead>";
		for(let guildKey in countInfo[key].guild){
			let guild=countInfo[key].guild[guildKey];
			table+="<tr>"
			table+="<td>"+guildKey+"</td>"
			table+=guild.city.z!=undefined?'<td title="'+guild.city.z.join(",")+'">'+guild.city.z.length+'</td>':"<td>0</td>"
			table+=guild.city.j!=undefined?'<td title="'+guild.city.j.join(",")+'">'+guild.city.j.length+'</td>':"<td>0</td>"
			table+=guild.city.g!=undefined?'<td title="">'+guild.city.g.length+'</td>':"<td>0</td>"
			table+="<td>"+guild.orderCount+"</td>"
			table+="</tr>"
		}
		
		
		$("."+key+"Info").find("p").html(outline);
		$("."+key+"Info").find("table").html(table);
	}
}

function setMap(){
	var data=dataInfo.mapData
	data.splice(15,0,[])
	data.splice(201,0,[])
	data.splice(217,0,[])
	data.splice(231,0,[])
	data.splice(233,0,[])
	data.splice(247,0,[])
	data.splice(263,0,[])
	data.splice(449,0,[])
	for(let i=0;i<data.length;i++){

		var baseWidth=65;
		var baseHeight=65;
		var xPadding=3;
		var yPadding=3;
		let x=(i+1)%31!=0?(i+1)%31-1:31-1
		let y=Math.floor(i/31);
		if(data[i].NodeName!=undefined){
			let color=getFontAndColor(data[i].Country).color;
			let left=(x*(xPadding+baseWidth));
			let top=(y*(yPadding+baseWidth))
			let flagName=data[i].FlagName.length>0?data[i].FlagName:data[i].CityType==1?"":"N";
			let content='<b>'+data[i].NodeName+'</b><br>'+flagName;
			let title=data[i].CityType!=1?'公会：'+data[i].guildName+'\n 驻守将灵：'+data[i].Defenders_length+' \n 城防：'+data[i].DefenceTotal+'/'+(data[i].DefenceTotal-data[i].DefenceDestroy):"";
			let twinkle=(data[i].DefenceTotal-data[i].DefenceDestroy)<10000?"twinkle":""
			if(data[i].CityType==4){
				baseWidth-=50;
				baseHeight-=50;
				left+=32
				top+=32;	
				content=flagName
			}
			if(data[i].CityType==3){
				baseWidth-=30;
				baseHeight-=30;
				left+=20
				top+=20;
			}
			if(data[i].Defenders_length<data[i].DefenseNum){
				if(data[i].IsOpenStation){
					content+="<span>驻</span>"
				}else{
					content+='<span style="background:black" >驻</span>'
				}
			}
			let city='<div id="city'+i+'" class="city '+twinkle+'" title="'+title+'" style="border-color:'+color+';background:'+color+';width:'+baseWidth+'px;height:'+baseHeight+'px;left:'+left+'px;top:'+top+'px" title="">'+content+'</div>'
			$("#map").append(city)
			
		}
	}
	$("body").css({"width":parseInt($("#city30").css("left"))+parseInt($("#city30").css("width"))+"px","height":parseInt($("#city434").css("top"))+parseInt($("#city434").css("height"))+"px"})
}
function formatDate(inputTime) {
        var date = new Date(inputTime);
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        m = m < 10 ? ('0' + m) : m;
        var d = date.getDate();
        d = d < 10 ? ('0' + d) : d;
        var h = date.getHours();
        h = h < 10 ? ('0' + h) : h;
        var minute = date.getMinutes();
        var second = date.getSeconds();
        minute = minute < 10 ? ('0' + minute) : minute;
        second = second < 10 ? ('0' + second) : second;
        return y + '-' + m + '-' + d+' '+h+':'+minute+':'+second;
      }
	  
function orderCountObj(obj){
	let guild=obj.guild;
	var keysSorted = Object.keys(guild).sort(function(a,b){return guild[b].orderCount-guild[a].orderCount})
	var newGuild=[]
	for(let i=0;i<keysSorted.length;i++){
		newGuild[keysSorted[i]]=guild[keysSorted[i]];
	}
	obj.guild=newGuild;
	return obj;
}
function refreshPage(){now=Date.parse(new Date())/1000;location.href=location.origin+location.pathname+"?"+now;}
setInterval(refreshPage,300000)
</script>


<style>
.twinkle{ -webkit-animation: twinkling 2s infinite ease-in-out } 
.animated{ -webkit-animation-duration: 2s; animation-duration: 2s; -webkit-animation-fill-mode: both; animation-fill-mode: both } 
@-webkit-keyframes twinkling{ 0%{ opacity: 0.3; } 100%{ opacity: 1; } } 
@keyframes twinkling{ 0%{ opacity: 0.3; } 100%{ opacity: 1; } }
body{cursor:grab;padding:10px}

*{padding:0;margin:0;moz-user-select: -moz-none;-moz-user-select: none;-o-user-select:none;-khtml-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;}
#map{position:relative}
#tips{line-height:1.5;list-style-type: decimal;list-style-position:inside;margin-bottom:20px}
#tips li{ font-size:12px}
.city{cursor:pointer;position:absolute;;border:1px solid #ccc;text-align:center;font-size:10px;color:white;display: box; display: -webkit-box; display: -moz-box; box-pack:center; -webkit-box-pack:center; -moz-box-pack:center; -webkit-box-align:center; -moz-box-align:center; } 
.city b{ font-size:14px;line-height:1.2;white-space:nowrap;}
.city span{position:absolute;background:red;top:-10px;padding:2px; border-radius:20px}
#count table td{ min-width:80px;text-align:center; line-height:2;padding:0 3px;}
#count{width:1920px;}
#count p.tit{margin-top:30px;margin-bottom:10px;font-size:35px;font-weight:bold}

#count ul{display:flex;list-style:none;justify-content:space-between;width:100%}
.qunInfo,.qunInfo td{color:#ff8216 !important}
.weiInfo,.weiInfo td{color:#55a6fd !important}
.shuInfo,.shuInfo td{color:#960b0e !important}
.wuInfo,.wuInfo td{color:#00af50 !important}
thead{ font-weight:bold;}
td{border:1px solid #ccc;cursor:pointer;}
table{border-collapse:collapse}
</style>
<script>
	
	$("body").mousedown(function(e){
		$("body").css("cursor","grabbing")
		var distenceX = e.pageX;
		var distenceY = e.pageY;
		$(document).mousemove(function(e){
			 var x = e.pageX - distenceX;
			 var y = e.pageY - distenceY;
			 if(x!=distenceX){
				$("body").scrollLeft($("body").scrollLeft()+~x)
			 }
			 if(y!=distenceY){
				$("body").scrollTop($("body").scrollTop()+~y)
			 }
		})
		$(document).mouseup(function() {
			$("body").css("cursor","grab")
			$(document).off('mousemove');
		});
	})
</script>
